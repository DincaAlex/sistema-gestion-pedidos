name: SonarCloud Unified Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-and-analyze:
    name: Build and Analyze All Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # Build all Gradle projects
      - name: Build Gradle projects
        run: |
          echo "Building Gradle projects..."

          # Registry Service
          if [ -f "registry-service/gradlew" ]; then
            chmod +x registry-service/gradlew
            cd registry-service && ./gradlew clean build -x test && cd ..
          fi

          # MS Productos
          if [ -f "ms-productos/gradlew" ]; then
            chmod +x ms-productos/gradlew
            cd ms-productos && ./gradlew clean build -x test && cd ..
          fi

          # MS Productos V2
          if [ -f "ms-productos-v2/gradlew" ]; then
            chmod +x ms-productos-v2/gradlew
            cd ms-productos-v2 && ./gradlew clean build -x test && cd ..
          fi

          # MS Productos V3
          if [ -f "ms-productos-v3/gradlew" ]; then
            chmod +x ms-productos-v3/gradlew
            cd ms-productos-v3 && ./gradlew clean build -x test && cd ..
          fi

          # MS Productos Writer
          if [ -f "ms-productos-writer/gradlew" ]; then
            chmod +x ms-productos-writer/gradlew
            cd ms-productos-writer && ./gradlew clean build -x test && cd ..
          fi

          # Gateway Service
          if [ -f "gateway-service/gradlew" ]; then
            chmod +x gateway-service/gradlew
            cd gateway-service && ./gradlew clean build -x test && cd ..
          fi

      # Build all Maven projects
      - name: Build Maven projects
        run: |
          echo "Building Maven projects..."

          # MS Config Server
          if [ -f "ms-config-server/pom.xml" ]; then
            echo "Building ms-config-server..."
            cd ms-config-server
            chmod +x mvnw
            ./mvnw clean compile -DskipTests
            cd ..
          fi

          # OAuth Server
          if [ -f "oauth-server/pom.xml" ]; then
            echo "Building oauth-server..."
            cd oauth-server
            chmod +x mvnw
            ./mvnw clean compile -DskipTests
            cd ..
          fi

          # OAuth Client
          if [ -f "oauth-client/pom.xml" ]; then
            echo "Building oauth-client..."
            cd oauth-client
            chmod +x mvnw
            ./mvnw clean compile -DskipTests
            cd ..
          fi

          # Resource Server
          if [ -f "resource-server/pom.xml" ]; then
            echo "Building resource-server..."
            cd resource-server
            chmod +x mvnw
            ./mvnw clean compile -DskipTests
            cd ..
          fi

          # MS Pedidos
          if [ -f "ms-pedidos/pom.xml" ]; then
            echo "Building ms-pedidos..."
            cd ms-pedidos
            chmod +x mvnw
            ./mvnw clean compile -DskipTests
            cd ..
          fi

      - name: Verify build outputs
        run: |
          echo "Checking build directories..."
          ls -la */build/classes/java/main 2>/dev/null || true
          ls -la */target/classes 2>/dev/null || true
          echo "Checking test directories..."
          find . -path "*/src/test/java" -type d

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
