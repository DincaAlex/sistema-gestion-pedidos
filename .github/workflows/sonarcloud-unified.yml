name: SonarCloud Unified Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-and-analyze:
    name: Build and Analyze All Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # Build all Gradle projects with tests and JaCoCo
      - name: Build and Test Gradle projects
        run: |
          echo "Building and testing Gradle projects with JaCoCo..."

          # Registry Service
          if [ -f "registry-service/gradlew" ]; then
            chmod +x registry-service/gradlew
            cd registry-service && ./gradlew clean build test jacocoTestReport && cd ..
          fi

          # MS Productos
          if [ -f "ms-productos/gradlew" ]; then
            chmod +x ms-productos/gradlew
            cd ms-productos && ./gradlew clean build test jacocoTestReport && cd ..
          fi

          # MS Productos V2
          if [ -f "ms-productos-v2/gradlew" ]; then
            chmod +x ms-productos-v2/gradlew
            cd ms-productos-v2 && ./gradlew clean build test jacocoTestReport && cd ..
          fi

          # MS Productos V3
          if [ -f "ms-productos-v3/gradlew" ]; then
            chmod +x ms-productos-v3/gradlew
            cd ms-productos-v3 && ./gradlew clean build test jacocoTestReport && cd ..
          fi

          # MS Productos Writer
          if [ -f "ms-productos-writer/gradlew" ]; then
            chmod +x ms-productos-writer/gradlew
            cd ms-productos-writer && ./gradlew clean build test jacocoTestReport && cd ..
          fi

          # Gateway Service
          if [ -f "gateway-service/gradlew" ]; then
            chmod +x gateway-service/gradlew
            cd gateway-service && ./gradlew clean build test jacocoTestReport && cd ..
          fi

      # Build and test all Maven projects with JaCoCo
      - name: Build and Test Maven projects
        run: |
          echo "Building and testing Maven projects with JaCoCo..."

          # MS Config Server
          if [ -f "ms-config-server/pom.xml" ]; then
            echo "Building and testing ms-config-server..."
            cd ms-config-server
            chmod +x mvnw
            ./mvnw clean test jacoco:report
            cd ..
          fi

          # # OAuth Server - Temporarily disabled due to test issues
          # if [ -f "oauth-server/pom.xml" ]; then
          #   echo "Building and testing oauth-server..."
          #   cd oauth-server
          #   chmod +x mvnw
          #   ./mvnw clean test jacoco:report
          #   cd ..
          # fi

          # # OAuth Client - Temporarily disabled due to test issues
          # if [ -f "oauth-client/pom.xml" ]; then
          #   echo "Building and testing oauth-client..."
          #   cd oauth-client
          #   chmod +x mvnw
          #   ./mvnw clean test jacoco:report
          #   cd ..
          # fi

          # # Resource Server - Temporarily disabled due to test issues
          # if [ -f "resource-server/pom.xml" ]; then
          #   echo "Building and testing resource-server..."
          #   cd resource-server
          #   chmod +x mvnw
          #   ./mvnw clean test jacoco:report
          #   cd ..
          # fi

          # # MS Pedidos - Temporarily disabled due to test issues
          # if [ -f "ms-pedidos/pom.xml" ]; then
          #   echo "Building and testing ms-pedidos..."
          #   cd ms-pedidos
          #   chmod +x mvnw
          #   ./mvnw clean test jacoco:report
          #   cd ..
          # fi

      - name: Verify build outputs
        run: |
          echo "Checking build directories..."
          ls -la */build/classes/java/main 2>/dev/null || true
          ls -la */target/classes 2>/dev/null || true
          echo "Checking test directories..."
          find . -path "*/src/test/java" -type d

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
